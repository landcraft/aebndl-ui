<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEBN VOD Downloader</title>
    <link rel="stylesheet" href="/static/styles.css?v=2">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="container">
        <header>
            <h1>AEBN Downloader</h1>
            <button id="theme-toggle" class="theme-toggle" title="Toggle Theme">
                <!-- Simple SVG Icon (Sun/Moon) -->
                <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
        </header>

        <!-- Layout: Vertical Stack -->
        <div class="layout-stack">
            <!-- Section 1: New Download -->
            <section class="card">
                <div class="card-header">New Download</div>
                <form id="download-form">
                    <div class="form-row">
                        <div class="input-group" style="flex: 3;">
                            <label for="url">Video URL</label>
                            <input type="text" id="url" name="url" placeholder="https://aebn.net/..." required>
                        </div>

                        <div class="input-group" style="flex: 1;">
                            <label for="threads">Threads</label>
                            <input type="number" id="threads" name="threads" value="10" min="1" max="20">
                        </div>

                        <div class="input-group" style="flex: 1;">
                            <label for="resolution">Resolution</label>
                            <select id="resolution" name="resolution">
                                <option value="2160">4K</option>
                                <option value="1440">1440p</option>
                                <option value="1080">1080p</option>
                                <option value="720" selected>720p</option>
                                <option value="480">480p</option>
                            </select>
                        </div>

                        <div class="input-group" style="flex: 1;">
                            <label for="scene">Scene (Opt)</label>
                            <input type="number" id="scene" name="scene" placeholder="1">
                        </div>

                        <div class="input-group" style="flex: 0 0 auto; align-self: flex-end;">
                            <button type="submit" id="start-btn" class="btn">Queue</button>
                        </div>
                    </div>
                </form>
            </section>

            <!-- Section 2: Status Table -->
            <section class="card">
                <div class="card-header">Job Status</div>
                <div class="table-responsive">
                    <table class="status-table">
                        <thead>
                            <tr>
                                <th style="width: 12%">Status</th>
                                <th style="width: 8%">Res</th>
                                <th style="width: 8%">Scene</th>
                                <th style="width: 42%">Name / URL</th>
                                <th style="width: 15%">Progress</th>
                                <th style="width: 15%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="job-table-body">
                            <tr>
                                <td colspan="4" class="empty-state">No active jobs</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Section 3: Footer -->
            <div class="system-info">
                <p>Core Version: <span id="sys-version">...</span></p>
                <p>Last Update: <span id="sys-date">...</span></p>
                <p style="margin-top: 0.5rem;"><a href="https://github.com/landcraft/aebndl-ui" target="_blank"
                        class="repo-link">View Project on GitHub</a></p>
            </div>
        </div>
    </div>

    <script>
        // Theme Logic
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const root = document.documentElement;

        // Icons
        const moonIcon = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
        const sunIcon = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';

        function setIcon(isLight) {
            themeIcon.innerHTML = isLight ? sunIcon : moonIcon;
        }

        // Load Saved Theme or System Preference
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersLight = window.matchMedia('(prefers-color-scheme: light)');

        function applyTheme(isLight) {
            if (isLight) {
                root.classList.add('light-mode');
                setIcon(true);
            } else {
                root.classList.remove('light-mode');
                setIcon(false);
            }
        }

        // Initialize
        if (savedTheme) {
            applyTheme(savedTheme === 'light');
        } else {
            applyTheme(systemPrefersLight.matches);
        }

        // Listen for system changes (only if no manual override)
        systemPrefersLight.addEventListener('change', (e) => {
            if (!localStorage.getItem('theme')) {
                applyTheme(e.matches);
            }
        });

        // Toggle Button
        themeToggle.addEventListener('click', () => {
            const isLightCurrently = root.classList.contains('light-mode');
            const newIsLight = !isLightCurrently;

            applyTheme(newIsLight);
            localStorage.setItem('theme', newIsLight ? 'light' : 'dark');
        });

        // Form Submission
        document.getElementById('download-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.textContent = '...';

            const formData = new FormData(e.target);
            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    body: formData
                });
                await response.json();
                document.getElementById('url').value = '';
            } catch (error) {
                alert('Error: ' + error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Queue';
            }
        });

        // Job Polling
        setInterval(async () => {
            try {
                const response = await fetch('/status');
                const jobs = await response.json();
                renderJobs(jobs);
            } catch (e) {
                console.error('Error:', e);
            }
        }, 1000);

        function renderJobs(jobs) {
            const tbody = document.getElementById('job-table-body');

            if (jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No active or recent jobs</td></tr>';
                return;
            }

            tbody.innerHTML = '';

            // Sort: Running > Queued > History
            const running = jobs.filter(j => ['running', 'downloading', 'muxing'].includes(j.status));
            const queued = jobs.filter(j => j.status === 'queued');
            const history = jobs.filter(j => !['running', 'downloading', 'muxing', 'queued'].includes(j.status));

            const displayJobs = [
                ...running,
                ...queued,
                ...history.reverse()
            ];

            displayJobs.forEach(job => {
                const tr = document.createElement('tr');

                // Status Badge
                let badgeClass = 'badge-default';
                if (['running', 'downloading'].includes(job.status)) badgeClass = 'badge-running';
                else if (job.status === 'muxing') badgeClass = 'badge-muxing';
                else if (job.status === 'completed') badgeClass = 'badge-success';
                else if (job.status === 'failed' || job.status === 'error') badgeClass = 'badge-error';
                else if (job.status === 'queued') badgeClass = 'badge-queued';

                // Progress Bar
                const progress = job.progress || 0;
                let progressHtml = `
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${progress}%"></div>
                        <span class="progress-text">${progress}%</span>
                    </div>
                `;
                if (job.status === 'error' || job.status === 'failed') {
                    progressHtml = `<span class="error-text">${job.message}</span>`;
                } else if (job.status === 'queued') {
                    progressHtml = `<span class="queued-text">Waiting...</span>`;
                }

                // Actions
                let actions = '';
                if (['running', 'downloading', 'muxing', 'queued'].includes(job.status)) {
                    actions = `<button onclick="stopJob('${job.id}')" class="btn-sm btn-stop">Stop</button>`;
                } else {
                    actions = `
                        <button onclick="restartJob('${job.id}')" class="btn-sm btn-restart">Restart</button>
                        <button onclick="deleteJob('${job.id}')" class="btn-sm btn-delete">Remove</button>
                    `;
                }

                const displayName = job.title ? job.title : job.url;
                const res = job.resolution || '-';
                const scene = job.scene || '-';

                tr.innerHTML = `
                    <td><span class="badge ${badgeClass}">${job.status.toUpperCase()}</span></td>
                    <td><span style="color: var(--text-secondary); font-size: 0.85rem;">${res}p</span></td>
                    <td><span style="color: var(--text-secondary); font-size: 0.85rem;">${scene}</span></td>
                    <td><div class="job-name" title="${job.url}">${displayName}</div></td>
                    <td>${progressHtml}</td>
                    <td>${actions}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Actions
        async function stopJob(id) {
            if (!confirm('Stop?')) return;
            await fetch(`/cancel/${id}`, { method: 'POST' });
        }

        async function restartJob(id) {
            if (!confirm('Restart?')) return;
            await fetch(`/restart/${id}`, { method: 'POST' });
        }

        async function deleteJob(id) {
            await fetch(`/delete/${id}`, { method: 'DELETE' });
        }

        // System Info
        window.addEventListener('load', async () => {
            try {
                const res = await fetch('/system-info');
                const data = await res.json();
                document.getElementById('sys-version').textContent = data.version;
                document.getElementById('sys-date').textContent = data.date;
            } catch (e) {
                console.error(e);
            }
        });
    </script>
</body>

</html>